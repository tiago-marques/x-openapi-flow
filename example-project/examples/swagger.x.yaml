version: "1.0"
operations:
  - operationId: createOrder
    x-openapi-flow:
      version: "1.0"
      id: create-order
      current_state: created
      description: Creates an order and opens the lifecycle in CREATED
      idempotency:
        header: Idempotency-Key
        required: true
      transitions:
        - trigger_type: synchronous
          condition: Payment is confirmed
          target_state: paid
          next_operation_id: payOrder
          prerequisite_operation_ids:
            - createOrder
          prerequisite_field_refs:
            - createOrder:request.body.customer_id
            - createOrder:request.body.amount
          propagated_field_refs:
            - createOrder:response.201.body.order_id
            - createOrder:response.201.body.status
        - trigger_type: polling
          condition: Payment status polling confirms authorization
          target_state: paid
          next_operation_id: payOrder
          prerequisite_operation_ids:
            - createOrder
            - getOrder
          prerequisite_field_refs:
            - createOrder:response.201.body.order_id
          propagated_field_refs:
            - createOrder:response.201.body.order_id

  - operationId: payOrder
    x-openapi-flow:
      version: "1.0"
      id: pay-order
      current_state: paid
      description: Captures payment and waits for fulfillment completion callback
      idempotency:
        header: Idempotency-Key
        required: true
      transitions:
        - trigger_type: webhook
          condition: Fulfillment provider callback is received
          target_state: fulfilled
          next_operation_id: fulfillOrder
          prerequisite_operation_ids:
            - createOrder
            - payOrder
          prerequisite_field_refs:
            - createOrder:response.201.body.order_id
            - payOrder:request.path.id
            - payOrder:response.200.body.order_id
            - payOrder:response.200.body.payment_id
          propagated_field_refs:
            - payOrder:response.200.body.order_id
            - payOrder:response.200.body.payment_status

  - operationId: fulfillOrder
    x-openapi-flow:
      version: "1.0"
      id: fulfill-order
      current_state: fulfilled
      description: Terminal operation for FULFILLED; prerequisites are declared in the incoming transition from payOrder
      idempotency:
        header: Idempotency-Key
        required: false
      transitions: []

  - operationId: getOrder
    x-openapi-flow:
      version: "1.0"
      id: get-order
      current_state: order_observed
      description: Read model operation used by polling transitions to observe order status
      transitions:
        - trigger_type: polling
          condition: Order status endpoint confirms payment status as paid
          target_state: paid
          next_operation_id: payOrder
          prerequisite_operation_ids:
            - getOrder
          prerequisite_field_refs:
            - getOrder:response.200.body.order_id
            - getOrder:response.200.body.status
          propagated_field_refs:
            - getOrder:response.200.body.order_id
            - getOrder:response.200.body.status

  - operationId: createRefund
    x-openapi-flow:
      version: "1.0"
      id: create-refund
      current_state: refund_requested
      description: Creates a refund request
      transitions:
        - trigger_type: synchronous
          condition: Refund request is approved
          target_state: refund_approved
          next_operation_id: approveRefund
          prerequisite_operation_ids:
            - createRefund
          prerequisite_field_refs:
            - createRefund:request.body.order_id
            - createRefund:request.body.amount
          propagated_field_refs:
            - createRefund:response.201.body.refund_id

  - operationId: approveRefund
    x-openapi-flow:
      version: "1.0"
      id: approve-refund
      current_state: refund_approved
      description: Terminal operation for approved refunds
      transitions: []
